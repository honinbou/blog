---
layout: post
title: 性能测试和调优
category: thinking
tags: [pyinotify]
---

性能测试和调优是一个比较复杂的问题，涉及到很多方面，这里总结一下之前做性能测试，查找系统瓶颈的经验。业界已经有人写了很多关于性能优化方法的文章，如：coolshell的博主陈皓的[《性能调优攻略》](http://coolshell.cn/articles/7490.html)

#系统性能的定义
对系统性能的度量，是我们后续定位和优化的第一步，开展性能测试，一般都是先测试出单机单模块的性能，根据这个基础性能，对各个模块的配比有个基本的认识。在组合出最平衡的组合后，对其进行性能测试，线上也按照这个比例上线，基本可以确定整个集群的服务能力。

一般我们无法直接对整个集群的服务能力进行测试，比如线上1000台云存储服务的集群，可能没有条件对这1000台进行性能测试，因为你需要大量的client机器，当然这种计算可能会不太准，会有一定比例的折损，因为大的系统中可能涉及网络通讯，试错等逻辑，导致实际结果偏低。

系统性能的定义一般有三个指标：

1. **QPS**(query per second) 每秒请求数，即服务器每秒能够服务的请求数目，单位：次/s；
2. **Latency** 时延，即每次请求所花费的时间，单位：ms；
3. **Throughput** 吞吐量 即网路卡上的数据流量，单位：KB/s, MB/s, etc；

三者之间有一定的制约关系：

1. 一般QPS越高，latency会越长，Throughput会越大，因为系统会更繁忙，可能会存在额外的调度等待导致latency变长，Throughput也会响应增加；
2. Latency越低，代表请求很快就结束了，这样单位时间内能够容纳的请求就越多，QPS就可以越高；
3. Throughput一般只要不是到达网卡瓶颈，基本上都不会有影响，但是需要注意，在目前多核心的机器上，如果网卡的中断能够均匀分布到多个核心上，能提高不少机器的性能；

系统的这个三个指标随着压力的增大，而没有提升，均是系统的某种资源达到瓶颈。下面介绍如何查看系统的稀缺资源

#系统资源介绍
对于计算机系统，一般的瓶颈在于三个方面：CPU、内存、IO，IO又分磁盘IO和网卡IO，下面分别对这四个资源的度量进行介绍

##CPU
CPU在linux系统中主要完成三个任务：

1. 用户态进程的执行
2. 系统内核的执行
3. idle状态

###cpu的度量

CPU的上述三个状态进一步细分可以分为：
* usr
* nice
* sys
* iowait
* irq
* soft
上面的状态公共mpstat命令可以很容易查看到

###cpu时间的计算

###cpu状态的查看和相关命令

###cpu的调优
####改多线程为使用epool
####多核心cpu绑定特定进程到指定cpu

##内存
内存完成的任务：

1. 进程的执行空间
2. 进程内分配的空间
3. 缓存
4. 空闲

###内存状态的查看和相关命令

### malloc和延时分配

###虚拟内存

##磁盘IO

###磁盘状态的查看和相关命令

###磁盘，内存和CPU之间的影响

##网卡IO
###网卡的基本状态

###网卡的状态查看和相关工具

###网卡的极限性能


#常用的性能测试工具

##HTTP：

###ab
###siege
###curl-loader

##XMPP
###TSung

#如何分析定位分析系统的瓶颈
1. 首先查看cpu，因为其最容易成为瓶颈

2. 查看网卡

3. 查看磁盘和内存

#典型的瓶颈demo

[performance]: http://coolshell.cn/articles/7490.html
